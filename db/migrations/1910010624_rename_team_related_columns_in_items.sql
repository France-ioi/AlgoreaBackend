-- +migrate Up
ALTER TABLE `items`
    ADD COLUMN `entry_participant_type` ENUM('User', 'Team') NOT NULL DEFAULT 'User'
        COMMENT 'For explicit-entry items, the type of participants who can enter'
            AFTER `default_language_id`;

UPDATE `items` SET `entry_participant_type` = IF(`team_mode` IS NULL, 'User', 'Team') WHERE `type` = 'Chapter';

UPDATE `items` SET `team_mode` = 'None' WHERE `team_mode` IS NULL;
UPDATE `history_items` SET `team_mode` = 'None' WHERE `team_mode` IS NULL;
ALTER TABLE `history_items`
    CHANGE COLUMN `team_mode` `contest_entering_condition` enum('All','Half','One','None') NOT NULL DEFAULT 'None',
    RENAME COLUMN `team_max_members` TO `contest_max_team_size`;
ALTER TABLE `items`
    CHANGE COLUMN `team_max_members` `contest_max_team_size` int(11) NOT NULL DEFAULT '0'
        COMMENT 'The maximum number of members a team can have to enter the contest',
    CHANGE COLUMN `team_mode` `contest_entering_condition` enum('All','Half','One','None') NOT NULL DEFAULT 'None'
        COMMENT 'The ratio of members in the team (a user alone being considered as a team of one) who needs the “can_enter” permission so that the group can enter',
    MODIFY `qualified_group_id` bigint(20) DEFAULT NULL
        COMMENT 'group id in which "qualified" users will belong. contest_entering_condition dictates how many of a team''s members must be "qualified" in order to start the item.';

DROP TRIGGER `after_insert_items`;
-- +migrate StatementBegin
CREATE TRIGGER `after_insert_items` AFTER INSERT ON `items` FOR EACH ROW BEGIN INSERT INTO `history_items` (`id`,`version`,`url`,`options`,`platform_id`,`text_id`,`repository_path`,`type`,`uses_api`,`read_only`,`full_screen`,`show_difficulty`,`show_source`,`hints_allowed`,`fixed_ranks`,`validation_type`,`validation_min`,`preparation_state`,`unlocked_item_ids`,`score_min_unlock`,`supported_lang_prog`,`default_language_id`,`contest_entering_condition`,`teams_editable`,`qualified_group_id`,`contest_max_team_size`,`has_attempts`,`contest_opens_at`,`duration`,`contest_closes_at`,`show_user_infos`,`contest_phase`,`level`,`no_score`,`title_bar_visible`,`transparent_folder`,`display_details_in_parent`,`display_children_as_tabs`,`custom_chapter`,`group_code_enter`) VALUES (NEW.`id`,@curVersion,NEW.`url`,NEW.`options`,NEW.`platform_id`,NEW.`text_id`,NEW.`repository_path`,NEW.`type`,NEW.`uses_api`,NEW.`read_only`,NEW.`full_screen`,NEW.`show_difficulty`,NEW.`show_source`,NEW.`hints_allowed`,NEW.`fixed_ranks`,NEW.`validation_type`,NEW.`validation_min`,NEW.`preparation_state`,NEW.`unlocked_item_ids`,NEW.`score_min_unlock`,NEW.`supported_lang_prog`,NEW.`default_language_id`,NEW.`contest_entering_condition`,NEW.`teams_editable`,NEW.`qualified_group_id`,NEW.`contest_max_team_size`,NEW.`has_attempts`,NEW.`contest_opens_at`,NEW.`duration`,NEW.`contest_closes_at`,NEW.`show_user_infos`,NEW.`contest_phase`,NEW.`level`,NEW.`no_score`,NEW.`title_bar_visible`,NEW.`transparent_folder`,NEW.`display_details_in_parent`,NEW.`display_children_as_tabs`,NEW.`custom_chapter`,NEW.`group_code_enter`); INSERT IGNORE INTO `items_propagate` (`id`, `ancestors_computation_state`) VALUES (NEW.`id`, 'todo') ; END
-- +migrate StatementEnd
DROP TRIGGER `before_update_items`;
-- +migrate StatementBegin
CREATE TRIGGER `before_update_items` BEFORE UPDATE ON `items` FOR EACH ROW BEGIN IF NEW.version <> OLD.version THEN SET @curVersion = NEW.version; ELSE SELECT ROUND(UNIX_TIMESTAMP(CURTIME(2)) * 10) INTO @curVersion; END IF; IF NOT (OLD.`id` = NEW.`id` AND OLD.`url` <=> NEW.`url` AND OLD.`options` <=> NEW.`options` AND OLD.`platform_id` <=> NEW.`platform_id` AND OLD.`text_id` <=> NEW.`text_id` AND OLD.`repository_path` <=> NEW.`repository_path` AND OLD.`type` <=> NEW.`type` AND OLD.`uses_api` <=> NEW.`uses_api` AND OLD.`read_only` <=> NEW.`read_only` AND OLD.`full_screen` <=> NEW.`full_screen` AND OLD.`show_difficulty` <=> NEW.`show_difficulty` AND OLD.`show_source` <=> NEW.`show_source` AND OLD.`hints_allowed` <=> NEW.`hints_allowed` AND OLD.`fixed_ranks` <=> NEW.`fixed_ranks` AND OLD.`validation_type` <=> NEW.`validation_type` AND OLD.`validation_min` <=> NEW.`validation_min` AND OLD.`preparation_state` <=> NEW.`preparation_state` AND OLD.`unlocked_item_ids` <=> NEW.`unlocked_item_ids` AND OLD.`score_min_unlock` <=> NEW.`score_min_unlock` AND OLD.`supported_lang_prog` <=> NEW.`supported_lang_prog` AND OLD.`default_language_id` <=> NEW.`default_language_id` AND OLD.`contest_entering_condition` <=> NEW.`contest_entering_condition` AND OLD.`teams_editable` <=> NEW.`teams_editable` AND OLD.`qualified_group_id` <=> NEW.`qualified_group_id` AND OLD.`contest_max_team_size` <=> NEW.`contest_max_team_size` AND OLD.`has_attempts` <=> NEW.`has_attempts` AND OLD.`contest_opens_at` <=> NEW.`contest_opens_at` AND OLD.`duration` <=> NEW.`duration` AND OLD.`contest_closes_at` <=> NEW.`contest_closes_at` AND OLD.`show_user_infos` <=> NEW.`show_user_infos` AND OLD.`contest_phase` <=> NEW.`contest_phase` AND OLD.`level` <=> NEW.`level` AND OLD.`no_score` <=> NEW.`no_score` AND OLD.`title_bar_visible` <=> NEW.`title_bar_visible` AND OLD.`transparent_folder` <=> NEW.`transparent_folder` AND OLD.`display_details_in_parent` <=> NEW.`display_details_in_parent` AND OLD.`display_children_as_tabs` <=> NEW.`display_children_as_tabs` AND OLD.`custom_chapter` <=> NEW.`custom_chapter` AND OLD.`group_code_enter` <=> NEW.`group_code_enter`) THEN   SET NEW.version = @curVersion;   UPDATE `history_items` SET `next_version` = @curVersion WHERE `id` = OLD.`id` AND `next_version` IS NULL;   INSERT INTO `history_items` (`id`,`version`,`url`,`options`,`platform_id`,`text_id`,`repository_path`,`type`,`uses_api`,`read_only`,`full_screen`,`show_difficulty`,`show_source`,`hints_allowed`,`fixed_ranks`,`validation_type`,`validation_min`,`preparation_state`,`unlocked_item_ids`,`score_min_unlock`,`supported_lang_prog`,`default_language_id`,`contest_entering_condition`,`teams_editable`,`qualified_group_id`,`contest_max_team_size`,`has_attempts`,`contest_opens_at`,`duration`,`contest_closes_at`,`show_user_infos`,`contest_phase`,`level`,`no_score`,`title_bar_visible`,`transparent_folder`,`display_details_in_parent`,`display_children_as_tabs`,`custom_chapter`,`group_code_enter`)       VALUES (NEW.`id`,@curVersion,NEW.`url`,NEW.`options`,NEW.`platform_id`,NEW.`text_id`,NEW.`repository_path`,NEW.`type`,NEW.`uses_api`,NEW.`read_only`,NEW.`full_screen`,NEW.`show_difficulty`,NEW.`show_source`,NEW.`hints_allowed`,NEW.`fixed_ranks`,NEW.`validation_type`,NEW.`validation_min`,NEW.`preparation_state`,NEW.`unlocked_item_ids`,NEW.`score_min_unlock`,NEW.`supported_lang_prog`,NEW.`default_language_id`,NEW.`contest_entering_condition`,NEW.`teams_editable`,NEW.`qualified_group_id`,NEW.`contest_max_team_size`,NEW.`has_attempts`,NEW.`contest_opens_at`,NEW.`duration`,NEW.`contest_closes_at`,NEW.`show_user_infos`,NEW.`contest_phase`,NEW.`level`,NEW.`no_score`,NEW.`title_bar_visible`,NEW.`transparent_folder`,NEW.`display_details_in_parent`,NEW.`display_children_as_tabs`,NEW.`custom_chapter`,NEW.`group_code_enter`) ; END IF; SELECT platforms.id INTO @platformID FROM platforms WHERE NEW.url REGEXP platforms.regexp ORDER BY platforms.priority DESC LIMIT 1 ; SET NEW.platform_id=@platformID ; END
-- +migrate StatementEnd
DROP TRIGGER `before_delete_items`;
-- +migrate StatementBegin
CREATE TRIGGER `before_delete_items` BEFORE DELETE ON `items` FOR EACH ROW BEGIN SELECT ROUND(UNIX_TIMESTAMP(CURTIME(2)) * 10) INTO @curVersion; UPDATE `history_items` SET `next_version` = @curVersion WHERE `id` = OLD.`id` AND `next_version` IS NULL; INSERT INTO `history_items` (`id`,`version`,`url`,`options`,`platform_id`,`text_id`,`repository_path`,`type`,`uses_api`,`read_only`,`full_screen`,`show_difficulty`,`show_source`,`hints_allowed`,`fixed_ranks`,`validation_type`,`validation_min`,`preparation_state`,`unlocked_item_ids`,`score_min_unlock`,`supported_lang_prog`,`default_language_id`,`contest_entering_condition`,`teams_editable`,`qualified_group_id`,`contest_max_team_size`,`has_attempts`,`contest_opens_at`,`duration`,`contest_closes_at`,`show_user_infos`,`contest_phase`,`level`,`no_score`,`title_bar_visible`,`transparent_folder`,`display_details_in_parent`,`display_children_as_tabs`,`custom_chapter`,`group_code_enter`, `deleted`) VALUES (OLD.`id`,@curVersion,OLD.`url`,OLD.`options`,OLD.`platform_id`,OLD.`text_id`,OLD.`repository_path`,OLD.`type`,OLD.`uses_api`,OLD.`read_only`,OLD.`full_screen`,OLD.`show_difficulty`,OLD.`show_source`,OLD.`hints_allowed`,OLD.`fixed_ranks`,OLD.`validation_type`,OLD.`validation_min`,OLD.`preparation_state`,OLD.`unlocked_item_ids`,OLD.`score_min_unlock`,OLD.`supported_lang_prog`,OLD.`default_language_id`,OLD.`contest_entering_condition`,OLD.`teams_editable`,OLD.`qualified_group_id`,OLD.`contest_max_team_size`,OLD.`has_attempts`,OLD.`contest_opens_at`,OLD.`duration`,OLD.`contest_closes_at`,OLD.`show_user_infos`,OLD.`contest_phase`,OLD.`level`,OLD.`no_score`,OLD.`title_bar_visible`,OLD.`transparent_folder`,OLD.`display_details_in_parent`,OLD.`display_children_as_tabs`,OLD.`custom_chapter`,OLD.`group_code_enter`, 1); END
-- +migrate StatementEnd


-- +migrate Down
ALTER TABLE `history_items`
    CHANGE COLUMN `contest_entering_condition` `team_mode` enum('All','Half','One','None') DEFAULT NULL,
    RENAME COLUMN `contest_max_team_size` TO `team_max_members`;
ALTER TABLE `items`
    CHANGE COLUMN `contest_max_team_size` `team_max_members` int(11) NOT NULL DEFAULT '0'
        COMMENT 'Maximum number of members of teams participating to this item',
    CHANGE COLUMN `contest_entering_condition` `team_mode` enum('All','Half','One','None') DEFAULT NULL
        COMMENT 'If qualified_group_id is not NULL, this field specifies how many team members need to belong to that group in order for the whole team to be qualified and able to start the item.',
    MODIFY `qualified_group_id` bigint(20) DEFAULT NULL
        COMMENT 'group id in which "qualified" users will belong. team_mode dictates how many of a team''s members must be "qualified" in order to start the item.',
    DROP COLUMN `entry_participant_type`;

DROP TRIGGER `after_insert_items`;
-- +migrate StatementBegin
CREATE TRIGGER `after_insert_items` AFTER INSERT ON `items` FOR EACH ROW BEGIN INSERT INTO `history_items` (`id`,`version`,`url`,`options`,`platform_id`,`text_id`,`repository_path`,`type`,`uses_api`,`read_only`,`full_screen`,`show_difficulty`,`show_source`,`hints_allowed`,`fixed_ranks`,`validation_type`,`validation_min`,`preparation_state`,`unlocked_item_ids`,`score_min_unlock`,`supported_lang_prog`,`default_language_id`,`team_mode`,`teams_editable`,`qualified_group_id`,`team_max_members`,`has_attempts`,`contest_opens_at`,`duration`,`contest_closes_at`,`show_user_infos`,`contest_phase`,`level`,`no_score`,`title_bar_visible`,`transparent_folder`,`display_details_in_parent`,`display_children_as_tabs`,`custom_chapter`,`group_code_enter`) VALUES (NEW.`id`,@curVersion,NEW.`url`,NEW.`options`,NEW.`platform_id`,NEW.`text_id`,NEW.`repository_path`,NEW.`type`,NEW.`uses_api`,NEW.`read_only`,NEW.`full_screen`,NEW.`show_difficulty`,NEW.`show_source`,NEW.`hints_allowed`,NEW.`fixed_ranks`,NEW.`validation_type`,NEW.`validation_min`,NEW.`preparation_state`,NEW.`unlocked_item_ids`,NEW.`score_min_unlock`,NEW.`supported_lang_prog`,NEW.`default_language_id`,NEW.`team_mode`,NEW.`teams_editable`,NEW.`qualified_group_id`,NEW.`team_max_members`,NEW.`has_attempts`,NEW.`contest_opens_at`,NEW.`duration`,NEW.`contest_closes_at`,NEW.`show_user_infos`,NEW.`contest_phase`,NEW.`level`,NEW.`no_score`,NEW.`title_bar_visible`,NEW.`transparent_folder`,NEW.`display_details_in_parent`,NEW.`display_children_as_tabs`,NEW.`custom_chapter`,NEW.`group_code_enter`); INSERT IGNORE INTO `items_propagate` (`id`, `ancestors_computation_state`) VALUES (NEW.`id`, 'todo') ; END
-- +migrate StatementEnd
DROP TRIGGER `before_update_items`;
-- +migrate StatementBegin
CREATE TRIGGER `before_update_items` BEFORE UPDATE ON `items` FOR EACH ROW BEGIN IF NEW.version <> OLD.version THEN SET @curVersion = NEW.version; ELSE SELECT ROUND(UNIX_TIMESTAMP(CURTIME(2)) * 10) INTO @curVersion; END IF; IF NOT (OLD.`id` = NEW.`id` AND OLD.`url` <=> NEW.`url` AND OLD.`options` <=> NEW.`options` AND OLD.`platform_id` <=> NEW.`platform_id` AND OLD.`text_id` <=> NEW.`text_id` AND OLD.`repository_path` <=> NEW.`repository_path` AND OLD.`type` <=> NEW.`type` AND OLD.`uses_api` <=> NEW.`uses_api` AND OLD.`read_only` <=> NEW.`read_only` AND OLD.`full_screen` <=> NEW.`full_screen` AND OLD.`show_difficulty` <=> NEW.`show_difficulty` AND OLD.`show_source` <=> NEW.`show_source` AND OLD.`hints_allowed` <=> NEW.`hints_allowed` AND OLD.`fixed_ranks` <=> NEW.`fixed_ranks` AND OLD.`validation_type` <=> NEW.`validation_type` AND OLD.`validation_min` <=> NEW.`validation_min` AND OLD.`preparation_state` <=> NEW.`preparation_state` AND OLD.`unlocked_item_ids` <=> NEW.`unlocked_item_ids` AND OLD.`score_min_unlock` <=> NEW.`score_min_unlock` AND OLD.`supported_lang_prog` <=> NEW.`supported_lang_prog` AND OLD.`default_language_id` <=> NEW.`default_language_id` AND OLD.`team_mode` <=> NEW.`team_mode` AND OLD.`teams_editable` <=> NEW.`teams_editable` AND OLD.`qualified_group_id` <=> NEW.`qualified_group_id` AND OLD.`team_max_members` <=> NEW.`team_max_members` AND OLD.`has_attempts` <=> NEW.`has_attempts` AND OLD.`contest_opens_at` <=> NEW.`contest_opens_at` AND OLD.`duration` <=> NEW.`duration` AND OLD.`contest_closes_at` <=> NEW.`contest_closes_at` AND OLD.`show_user_infos` <=> NEW.`show_user_infos` AND OLD.`contest_phase` <=> NEW.`contest_phase` AND OLD.`level` <=> NEW.`level` AND OLD.`no_score` <=> NEW.`no_score` AND OLD.`title_bar_visible` <=> NEW.`title_bar_visible` AND OLD.`transparent_folder` <=> NEW.`transparent_folder` AND OLD.`display_details_in_parent` <=> NEW.`display_details_in_parent` AND OLD.`display_children_as_tabs` <=> NEW.`display_children_as_tabs` AND OLD.`custom_chapter` <=> NEW.`custom_chapter` AND OLD.`group_code_enter` <=> NEW.`group_code_enter`) THEN   SET NEW.version = @curVersion;   UPDATE `history_items` SET `next_version` = @curVersion WHERE `id` = OLD.`id` AND `next_version` IS NULL;   INSERT INTO `history_items` (`id`,`version`,`url`,`options`,`platform_id`,`text_id`,`repository_path`,`type`,`uses_api`,`read_only`,`full_screen`,`show_difficulty`,`show_source`,`hints_allowed`,`fixed_ranks`,`validation_type`,`validation_min`,`preparation_state`,`unlocked_item_ids`,`score_min_unlock`,`supported_lang_prog`,`default_language_id`,`team_mode`,`teams_editable`,`qualified_group_id`,`team_max_members`,`has_attempts`,`contest_opens_at`,`duration`,`contest_closes_at`,`show_user_infos`,`contest_phase`,`level`,`no_score`,`title_bar_visible`,`transparent_folder`,`display_details_in_parent`,`display_children_as_tabs`,`custom_chapter`,`group_code_enter`)       VALUES (NEW.`id`,@curVersion,NEW.`url`,NEW.`options`,NEW.`platform_id`,NEW.`text_id`,NEW.`repository_path`,NEW.`type`,NEW.`uses_api`,NEW.`read_only`,NEW.`full_screen`,NEW.`show_difficulty`,NEW.`show_source`,NEW.`hints_allowed`,NEW.`fixed_ranks`,NEW.`validation_type`,NEW.`validation_min`,NEW.`preparation_state`,NEW.`unlocked_item_ids`,NEW.`score_min_unlock`,NEW.`supported_lang_prog`,NEW.`default_language_id`,NEW.`team_mode`,NEW.`teams_editable`,NEW.`qualified_group_id`,NEW.`team_max_members`,NEW.`has_attempts`,NEW.`contest_opens_at`,NEW.`duration`,NEW.`contest_closes_at`,NEW.`show_user_infos`,NEW.`contest_phase`,NEW.`level`,NEW.`no_score`,NEW.`title_bar_visible`,NEW.`transparent_folder`,NEW.`display_details_in_parent`,NEW.`display_children_as_tabs`,NEW.`custom_chapter`,NEW.`group_code_enter`) ; END IF; SELECT platforms.id INTO @platformID FROM platforms WHERE NEW.url REGEXP platforms.regexp ORDER BY platforms.priority DESC LIMIT 1 ; SET NEW.platform_id=@platformID ; END
-- +migrate StatementEnd
DROP TRIGGER `before_delete_items`;
-- +migrate StatementBegin
CREATE TRIGGER `before_delete_items` BEFORE DELETE ON `items` FOR EACH ROW BEGIN SELECT ROUND(UNIX_TIMESTAMP(CURTIME(2)) * 10) INTO @curVersion; UPDATE `history_items` SET `next_version` = @curVersion WHERE `id` = OLD.`id` AND `next_version` IS NULL; INSERT INTO `history_items` (`id`,`version`,`url`,`options`,`platform_id`,`text_id`,`repository_path`,`type`,`uses_api`,`read_only`,`full_screen`,`show_difficulty`,`show_source`,`hints_allowed`,`fixed_ranks`,`validation_type`,`validation_min`,`preparation_state`,`unlocked_item_ids`,`score_min_unlock`,`supported_lang_prog`,`default_language_id`,`team_mode`,`teams_editable`,`qualified_group_id`,`team_max_members`,`has_attempts`,`contest_opens_at`,`duration`,`contest_closes_at`,`show_user_infos`,`contest_phase`,`level`,`no_score`,`title_bar_visible`,`transparent_folder`,`display_details_in_parent`,`display_children_as_tabs`,`custom_chapter`,`group_code_enter`, `deleted`) VALUES (OLD.`id`,@curVersion,OLD.`url`,OLD.`options`,OLD.`platform_id`,OLD.`text_id`,OLD.`repository_path`,OLD.`type`,OLD.`uses_api`,OLD.`read_only`,OLD.`full_screen`,OLD.`show_difficulty`,OLD.`show_source`,OLD.`hints_allowed`,OLD.`fixed_ranks`,OLD.`validation_type`,OLD.`validation_min`,OLD.`preparation_state`,OLD.`unlocked_item_ids`,OLD.`score_min_unlock`,OLD.`supported_lang_prog`,OLD.`default_language_id`,OLD.`team_mode`,OLD.`teams_editable`,OLD.`qualified_group_id`,OLD.`team_max_members`,OLD.`has_attempts`,OLD.`contest_opens_at`,OLD.`duration`,OLD.`contest_closes_at`,OLD.`show_user_infos`,OLD.`contest_phase`,OLD.`level`,OLD.`no_score`,OLD.`title_bar_visible`,OLD.`transparent_folder`,OLD.`display_details_in_parent`,OLD.`display_children_as_tabs`,OLD.`custom_chapter`,OLD.`group_code_enter`, 1); END
-- +migrate StatementEnd

UPDATE `items` SET `team_mode` = NULL WHERE `team_mode` = 'None' AND NOT `has_attempts`;
UPDATE `history_items` SET `team_mode` = NULL WHERE `team_mode` = 'None' AND NOT `has_attempts`;
